# 04. UI仕様書：ピアノロール・エディター

## 1. 概要 (Overview)
`[Bass]` および `[Melody]` トラック専用の編集画面。「白紙」から始めるのではなく、**「AI（パターン）によるガイド」**の中で編集することを前提に設計する。

## 2. 基本ワークフロー
1.  ユーザーがピアノロールを開くと、`[ コード生成 ]` や `[ 鼻歌解析 ]` で**提案されたノートがすでに貼り付けられた状態**で始まる。
2.  ユーザーの作業は「修正」と「介入（手動/AI）」が中心となる。

## 3. ガイド機能 (UIの核)

### 1. ガイド・ハイライト (常時ON)
* **動作:** 「フリー・モード」（全鍵盤表示）時でも、`Chord` トラック（例：`Cmaj7`）に基づき、「安全な」音（ド, ミ, ソ, シ）の**鍵盤**が**「青色」**で常時ハイライトされる。
* **動的変化:** 再生ヘッドが小節内の次のコード（例：`G7`）に移動すると、ハイライトも**即座に**「ソ, シ, ファ」に切り替わる。
* **目的:** 「安全な音」と「介入的な（奇妙な）音」を視覚的に提示する。

### 2. 介入ノート・ハイライト (常時ON)
* **動作:** ユーザーが「ハイライトされていない（＝奇妙な）」音（例：`F#`）を実際に入力した場合、その**ノート**（ブロック）が**「赤色」**で表示される。
* **目的:** ユーザーに「今、自分は『介入』を行った」と自覚させる。

### 3. ガイド・モード (フィルター機能)
* **UI:** 「トラック・ビュー」（`docs/08`）の右親指エリア（COLUMN_3）に**常設**。
* **動作 (ONの場合):**
    * ピアノロールの縦軸（Y軸）から、「安全な音（青ハイライト）」**以外**の鍵盤が**非表示（またはグレーアウト）**になる。
* **目的:** 音楽理論を知らなくても、「安全な」メロディを簡単に入力できるようにする「強制的な」支援。

## 4. スナップ機能 (Snap Setting) - *最重要*
* **必須:** 「トラック・ビュー」（`docs/08`）の左親指エリア（COLUMN_1）に**常設**され、ユーザーが自由に切り替えられること。
    1.  **[ 小節 (Bar) ]**
    2.  **[ 拍 (Beat) ]**
    3.  **[ グリッド (Grid) ]** (8分, 16分, 3連符など)
    4.  **[ フリー (Free / No Snap) ]**
* **目的:** 「カッチリした」編集と、「人間的なグルーヴ（揺れ）」を活かした編集（`[フリー]`）の両方を可能にする。

## 5. 編集機能 (Editing Features)

### 1. カット / コピー / ペースト
* **操作:**
    1.  `[ 選択 ]` ツール（`docs/08` COLUMN_1）で、「開始位置」と「終了位置」をタップで指定。
    2.  この指定は、現在の「スナップ設定」に**自動的に吸着**する。
    3.  `[切り取り]`, `[コピー]` を（コンテキストメニューから）タップ。
    4.  再生カーソルを貼り付けたい位置に移動させ、`[貼り付け]` をタップする。

### 2. ノートの長さ編集（ハイブリッド方式）
* **A. ドラッグ操作（スピード）:**
    * ノートの「端」を指でドラッグして、**直感的に**長さを変更する。
    * このドラッグ操作は、**現在の「スナップ設定」に強制的に従う**（「不正確さ」の補正）。
* **B. タップ操作（確実性）:**
    * ノートを**1回タップ**すると表示される「コンテキスト・メニュー」から、**`[ 長くする (→) ]`** / **`[ 短くする (←) ]`** ボタンをタップし、スナップ単位で「カチッ」と長さを変更する。

### 3. ノートのピッチ編集（1音ずつの手動）
* ノートを**1回タップ**して選択し、指で**「上下」**にドラッグすることで、ピッチ（音高）を（スナップ設定に従って）変更できる。
* これにより、AIの提案に対する「小さな穴（あいまいさ）」を手動で作り出すことが**完全に保証**されている。
